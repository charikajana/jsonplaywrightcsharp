trigger: none

parameters:
- name: Env
  displayName: Environment
  type: string
  default: STAGING
  values: [DEV, QA, STAGING, PROD]

- name: Browser
  displayName: Browser
  type: string
  default: chromium
  values: [chromium, firefox, webkit]

- name: Tags
  displayName: Test Filter (Category)
  type: string
  default: 'login'

- name: PoolName
  displayName: Agent Pool
  type: string
  default: 'Azure Pipelines'
  values: ['Default', 'Azure Pipelines']

- name: EmailRecipients
  displayName: Email Notification Recipients
  type: string
  default: 'test@example.com'

variables:
  buildConfiguration: 'Debug'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  ALLURE_RESULTS_DIR: 'allure-results'

jobs:
- job: PlaywrightCSharpTests
  ${{ if eq(parameters.PoolName, 'Azure Pipelines') }}:
    pool:
      vmImage: 'ubuntu-latest'
  ${{ else }}:
    pool:
      name: ${{ parameters.PoolName }}
  
  timeoutInMinutes: 60
  steps:
  # 1. Setup .NET
  - task: UseDotNet@2
    displayName: 'Use .NET 10.x'
    inputs:
      packageType: 'sdk'
      version: '10.x'
  
  # 2. Setup Node.js (Required for Allure CLI)
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Install Node.js (Allure CLI)'

  # 3. Restore and Build
  - task: DotNetCoreInstaller@2
    inputs:
      version: '10.x'
  
  - script: |
      dotnet build --configuration $(buildConfiguration)
    displayName: 'Build Solution'

  # 4. Install Playwright Browsers
  - script: |
      dotnet tool install --global Microsoft.Playwright.CLI || true
      pwsh PlaywrightJsonFramework.Tests/bin/$(buildConfiguration)/net10.0/playwright.ps1 install --with-deps
    displayName: 'Install Playwright Browsers'

  # 5. Execute Tests
  - script: |
      mkdir -p $(ALLURE_RESULTS_DIR)
      dotnet test PlaywrightJsonFramework.Tests/PlaywrightJsonFramework.Tests.csproj \
        --configuration $(buildConfiguration) \
        --filter "Category=${{ parameters.Tags }}" \
        --logger "trx;LogFileName=results.trx"
    displayName: 'Run Playwright Hybrid Tests'
    env:
      TEST_ENV: ${{ parameters.Env }}
      BROWSER: ${{ parameters.Browser }}
      HEADLESS: "true"
      RESULTS_URL: "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.Id)"
      BUILD_BUILDNUMBER: $(Build.BuildNumber)
      ALLURE_RESULTS_DIRECTORY: $(System.DefaultWorkingDirectory)/$(ALLURE_RESULTS_DIR)
      ALLURE_DIRECTORY: $(System.DefaultWorkingDirectory)/$(ALLURE_RESULTS_DIR)
      ALLURE_CONFIG: $(System.DefaultWorkingDirectory)/PlaywrightJsonFramework.Tests/allureConfig.json
      ENABLE_EMAIL: "true"
      RECIPIENT_EMAIL: ${{ parameters.EmailRecipients }}
      SMTP_HOST: $(SMTP_HOST)
      SMTP_PORT: $(SMTP_PORT)
      SMTP_USER: $(SMTP_USER)
      SMTP_PASS: $(SMTP_PASS)
    continueOnError: true

  # 6. Publish Basic Test Results (NUnit/TRX)
  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '**/results.trx'
      mergeTestResults: true
      testRunTitle: 'Playwright C# - ${{ parameters.Env }} - ${{ parameters.Browser }}'
    displayName: 'Publish VSTest Results'

  # 7. Allure Reporting
  # Metadata is automatically generated by Framework code during test run
  - script: |
      echo "--- Locating all Allure result files (*-result.json) ---"
      find . -name "*-result.json"
      
      echo "--- Consolidating Allure results ---"
      mkdir -p consolidated-results
      
      # Copy results from ANY directory named allure-results
      find . -type d -name "allure-results" -not -path "./consolidated-results*" | while read dir; do
        echo "Copying from $dir..."
        cp -r "$dir"/. ./consolidated-results/ 2>/dev/null || true
      done
      
      echo "--- Consolidated results content ---"
      ls -la consolidated-results
      
      if [ "$(ls -A consolidated-results 2>/dev/null)" ]; then
        npx allure-commandline generate consolidated-results --clean -o allure-report
      else
        echo "##[warning]No Allure results found! Report will be empty."
        mkdir -p allure-report
      fi
    displayName: 'Allure: Generate Report'
    condition: succeededOrFailed()

  - task: PublishAllureReport@2
    displayName: 'Allure: Publish to Tab'
    condition: succeededOrFailed()
    continueOnError: true
    inputs:
      reportDir: 'allure-report'
      testResultsDir: 'consolidated-results'
      allureVersion: '2.34.1'
      reportName: 'Playwright C# Allure Report'

  # 8. Publish Artifacts
  - task: PublishPipelineArtifact@1
    condition: succeededOrFailed()
    inputs:
      targetPath: 'allure-report'
      artifact: 'AllureReport'
    displayName: 'Allure: Publish Artifact'
